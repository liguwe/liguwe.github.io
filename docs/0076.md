
---


#vue 

# Vue3 中 Teleport 组件的实现原理


简单说就是，蒙层 `z-index` 的问题，所以必须渲染到 `body` 或者挂载到父元素上才行，vue3 本身提供内部组件来支持这个功能


## 实现渲染逻辑分离


将 Teleport 组件的渲染逻辑从渲染器中分离出来，这么做有两点好处：

- 可以**避免渲染器逻辑代码“膨胀”**； 
- **方便TreeShaking**：当用户没有使用 Teleport 组件时，由于 Teleport 的渲染逻辑被分离，因此可以利用 TreeShaking 机制在最终的 bundle 中删除 Teleport 相关的代码，使得最终构建包的体积变小

下面是 patch 函数：

![image.png|600](https://od-1310531898.cos.ap-beijing.myqcloud.com/202306231051512.png)


## 以下面模板为示例

![image.png|405](https://od-1310531898.cos.ap-beijing.myqcloud.com/202306231053044.png)

所以具体对应的 vdom 如下：

![image.png|600](https://od-1310531898.cos.ap-beijing.myqcloud.com/202306231054304.png)


## 最终代码

```javascript
const Teleport = {
  __isTeleport: true,
  process(n1, n2, container, anchor, internals) {
    const { patch, patchChildren, move } = internals
    if (!n1) {
      // 挂载
        // :::: 使用 to属性 去查找 DOM 节点
      const target = typeof n2.props.to === 'string'
        ? document.querySelector(n2.props.to)
        : n2.props.to
      n2.children.forEach(c => patch(null, c, target, anchor))
    } else {
      // 更新
      patchChildren(n1, n2, container)
      if (n2.props.to !== n1.props.to) {
          // :::: 使用 to属性 去查找 DOM 节点
        const newTarget = typeof n2.props.to === 'string'
          ? document.querySelector(n2.props.to)
          : n2.props.to
        n2.children.forEach(c => move(c, newTarget))
      }
    }
  }
}
```


## 最后

看看 `Teleport` 单词含义：

v. 心灵运输（物体、人）；远距离传送
n. 通信卫星；心灵传输


**即，Teleport组件 将模板渲染到其他节点下，即跨越 DOM 层级渲染**


---
<div class="liguwe-doc-footer">
            <p class="liguwe-doc-footer-update-time"><i>Last updated：2023.06.23</i></p>
            <div class="liguwe-doc-footer-edit-link">
                <a href="https://www.yuque.com/liguwe/post/0076" target="_blank" class="liguwe-doc-footer-edit-link-a">View this page on Yuque（语雀）</a>
                <a href="https://github.com/liguwe/liguwe.github.io/issues/new?title=0076.Vue3中 Teleport 组件的实现原理@Vue&labels=liguwe.site" target="_blank" class="liguwe-doc-footer-edit-link-a">Comment this page on GitHub Issues</a>
            </div>
        </div>