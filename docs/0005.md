
#fe #渲染  #css 

# FE.说说回流及重绘


## 先看定义


`回流`：布局引擎会根据各种样式计算每个盒子在页面上的大小与位置

`重绘`：当计算好盒模型的位置、大小及其他属性后，浏览器根据每个盒子特性进行绘制

`重绘`不一定导致`重排`，但`重排`一定会导致`重绘`  ，如下图：

![image.png](https://od-1310531898.cos.ap-beijing.myqcloud.com/202303181222365.png)



## 导致`回流`的场景

- 页面`首次渲染`
- 浏览器`窗口大小`发生改变
- 元素`尺寸或位置`发生改变
- 元素内容变化（`文字数量`或`图片大小`等等）
- 元素`字体大小`变化
- `添加或者删除`可见的DOM元素
- 激活CSS伪类（例如：`:hover`）
- `calc()` 本身不会引起 `回流`，但是因为需要重新计算布局的属性，比如父元素的宽度改变了，那必然会导致子元素的一个 `回流`
- `查询某些属性`或`调用某些方法`
	- `dom.style.width/height` ，只能取`行内样式的宽和高`，`style` 中 `link` 外链取不到。可写，修改时会导致`重排`
	- `window.getComputedStyle(dom).width/height`，指定`第二参数`指定一个要匹配的伪元素的字符串。必须对普通元素省略（`或null`） ，
		- 读取的样式是`最终样式`，包括了内联样式、嵌入样式和外部样式
		- 比如`getComputedStyle(h3, '::after').content` 
		- 会导致`回流` 因为它需要获取祖先节点的一些信息进行计算（譬如宽高等），为求一个`“即时性”`和`“准确性”`。
	- `dom.getBoundingClientRect().width/height 、top/left/right/bottom`  得到`渲染后的宽和高`，及`相对于视窗的上下左右`的距离
	- 获取`布局信息`时，会导致`重排`。相关的方法属性如 `offsetTop`   `getComputedStyle` 等
	- `scrollIntoView()`、`scrollIntoViewIfNeeded()` 、 `scrollTo()` 滚动时，会导致`重排`



> [!info]
>  总之， `查询某些属性`或`调用某些方法` 是否会导致重排，关键需要看  `只读了` ，还是有`写入`操作
``



> [!warning]
>  另外一些容易被忽略的操作：如 getComputedStyle，  offsetTop、offsetLeft、 offsetWidth、offsetHeight、scrollTop、scrollLeft、scrollWidth、scrollHeight、clientTop、clientLeft、clientWidth、clientHeight 这些属性有一个共性，就是需要通过**即时计算**得到。因此浏览器为了获取这些值，也会进行`回流`


## opacity、display 和 visibility 

- 修改 `opacity` 和 `visibility` 属性通常只会触发`重绘`，而不会触发`回流`
- 而修改 `display` 属性则可能会触发`回流和重绘` 

![image.png](https://od-1310531898.cos.ap-beijing.myqcloud.com/202303181135472.png)


## 修改  `left` 和 `right`  

一般情况下，如果只是修改 `left` 和 `right`  的值，不会导致 `回流`，因为脱离文档流，但同时改变其他属性值，会导致 `重排`


## 一些建议

-  `transform` 代替 `top/left` 
-  `position: absolute、fixed `  脱离文档流，以避免对其他元素布局的影响。
- 避免使用 `table` 布局
-  避免多次回流，尽量`批量操作`
	-  使用`documentFragment` 一次性插入文档中
	-  `classList.add/remove/toggle` 来切换样式，而不是直接修改 style 属性
- 避免使用`CSS表达式`（如：`calc()`）
- 使用`css3硬件加速`，`可以让transform`、`opacity`、`filters` 这些动画不会引起`回流重绘`
- `离线操作思路` ，及设置 `display:none`  ，其实也是 批量操作的一种思路
---
<div class="liguwe-doc-footer">
            <p class="liguwe-doc-footer-update-time"><i>Last updated：2023.03.17</i></p>
            <div class="liguwe-doc-footer-edit-link">
                <a href="https://www.yuque.com/liguwe/post/0005" target="_blank" class="liguwe-doc-footer-edit-link-a">View this page on Yuque（语雀）</a>
                <a href="https://github.com/liguwe/liguwe.github.io/issues/new?title=0005.说说回流及重绘@FE&labels=liguwe.site" target="_blank" class="liguwe-doc-footer-edit-link-a">Comment this page on GitHub Issues</a>
            </div>
        </div>