
# Umi 4 çš„è®¾è®¡æ€è·¯

`#å‰ç«¯å·¥ç¨‹åŒ–` `#2022/12`  


## ç›®å½•
<!-- toc -->
 ## æ€»ç»“ 

- æœ€ä½³å·¥ç¨‹åŒ–çš„å®è·µé›†åˆ
- é‚£ä¹ˆ`ç¼–è¯‘æ—¶æ¡†æ¶`å’Œ`éç¼–è¯‘æ—¶æ¡†æ¶`çš„åŒºåˆ«æ˜¯å•¥ï¼Ÿ
	- `éç¼–è¯‘æ—¶æ¡†æ¶`
		- æ¯”å¦‚éå¸¸æµè¡Œçš„ `create-react-app`ï¼ŒæŠŠæºç ç®€å•ç›´æ¥åœ°äº¤ç»™ `webpack` å°±å®Œæˆä½¿å‘½ï¼›
	- `ç¼–è¯‘æ—¶æ¡†æ¶`åˆ™ä¼šè‡ªå·±åŠ å¾ˆå¤šæˆ
		- æ¯”å¦‚æ‹¿åˆ°æºç å==åš ast åˆ†æï¼Œæ‹¿åˆ°ä¾èµ–å›¾è°±ï¼Œåšæ£€æŸ¥ï¼Œç”Ÿæˆä¸´æ—¶æ–‡ä»¶==ï¼Œç­‰ç­‰ï¼Œ
			- æœ€åæŠŠç¼–è¯‘åçš„æºç äº¤ç»™ `webpack`ï¼Œè¿™ä¸­é—´çš„å¾ˆå¤šäº‹ï¼Œæœ¬æ¥æ˜¯éœ€è¦å¼€å‘è€…æ‰‹åŠ¨å¤„ç†æˆ–ç¼–ç çš„ã€‚
- çº¦ç‚¹
	- æ¯”å¦‚åœ¨ `pages` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å³æ˜¯**è·¯ç”±**
	- æ–°å»º `access.ts` æ–‡ä»¶å³æ˜¯**æƒé™**
	- åœ¨ `locales` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å³æ˜¯`å›½é™…åŒ–è¯­è¨€`
	- ç­‰ç­‰
- Normal Mode ã€ Low Import Mode 
	- improt all from umi
- `Semver` ==Semantic Versioningï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰== çš„é—®é¢˜ ï¼Ÿ
- é¢„æ‰“åŒ…
	- ncc
		- ç”¨äºå°† Node.js æ¨¡å—**ç¼–è¯‘æˆä¸€ä¸ªå•ä¸€æ–‡ä»¶ï¼Œè¿åŒå…¶æ‰€æœ‰ä¾èµ–é¡¹ï¼Œç±»ä¼¼äº gcc é£æ ¼**ã€‚
	- é€šè¿‡ `ncc` å’Œ `dts-packer` å®ç°
		- ä¼šåˆ†åˆ«åœ¨ compiled/webpack ç›®å½•ç”Ÿæˆ `index.js` å’Œ `index.d.ts`ï¼Œä»¥å®ç°é¢„æ‰“åŒ…çš„ç›®çš„
- esm cdn & npm cdn æ–¹æ¡ˆ
- æ•°æ®é‡åŒ–
	- æœåŠ¡äº†å¤šå°‘ä¸ªé¡¹ç›®ï¼Ÿ

> æ¥è‡ª umi ä½œè€… CC çš„åˆ†äº«ï¼š https://www.yuque.com/seeconf/2022/ibm88n

## 1. æœ€ä½³å·¥ç¨‹åŒ–çš„å®è·µé›†åˆ

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-1.png)

## 2. ç‰¹ç‚¹

- all in one
	- improt all from umi
	- low import mode
- çº¦æŸä¸å¼€æ”¾
	- å¼ºçº¦æŸ
- ç¼–è¯‘æ—¶æ¡†æ¶
- åŒå¼•æ“æ„å»º
- esm cdn
- åº”ç”¨äº‘æ•°æ®

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-2.png)

## 3. ç¼–è¯‘æ—¶æ¡†æ¶

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-3.png)

ç›¸æ¯” 10 å¹´å‰å‰ç«¯ç¼–ç æœ‰äº†å¾ˆå¤šå˜åŒ–ï¼Œä»¥ä¸‹è¿™äº›æ˜¯å’Œ**ç¼–è¯‘æ—¶**ç›¸å…³çš„ã€‚

- ä»£ç å†™å°‘äº†
	- å°‘äº†å¾ˆå¤šè„šæ‰‹æ¶ä»£ç 
		- æ¯”å¦‚æ•°æ®æµã€å›½é™…åŒ–ã€æ¨¡å—åŠ è½½ã€è·¯ç”±ç­‰ï¼Œä»è€Œè®©å¼€å‘è€…æœ‰æ›´å¤šç²¾åŠ›**ä¸“æ³¨åœ¨ä¸šåŠ¡è§†å›¾å’Œé€»è¾‘ä¸Š**ï¼›
- æŠ¥é”™æå‰äº†
	- æ¯”å¦‚æ¨¡å—ä¸å­˜åœ¨ï¼Œä½¿ç”¨äº†ä¸å­˜åœ¨çš„å˜é‡ï¼Œä¹‹å‰æ˜¯è¿è¡Œæ—¶æ‰èƒ½å‘ç°ï¼Œç°åœ¨**æŠ¥é”™æå‰äº†**ï¼Œåœ¨**å‘½ä»¤è¡Œé‡Œå°±èƒ½çœ‹åˆ°**ã€‚
	- é™¤äº† DX çš„æå‡ï¼Œé¢å¤–çš„å¥½å¤„çš„æ­¤ç±»é—®é¢˜ä¸ä¼šå†è¢«å¸¦åˆ°çº¿ä¸Šï¼›
- äº§ç‰©å˜å°äº†
	- ä¹‹å‰ç”¨ä¸€ä¸ª button è¦å¼•å…¥æ•´ä¸ª antdï¼Œç”¨ä¸€ä¸ª isEqual è¦å¼•å…¥æ•´ä¸ª lodash
	- ç°åœ¨é€šè¿‡ tree-shaking æˆ– babel-plugin-import æˆ– TailwindCSS çš„ JIT å¼•æ“ï¼Œèƒ½å‡†ç¡®çŸ¥é“ä½ ç”¨äº†å•¥ï¼Œç„¶ååšæŒ‰éœ€æ‰“åŒ…ï¼Œè®©äº§ç‰©å˜å°ï¼›
- åŠŸèƒ½==é…ç½®åŒ–==äº†
	- ç°åœ¨å¾ˆå¤šæ ‡å‡†åŒ–çš„åŠŸèƒ½éƒ½é…ç½®åŒ–äº†ï¼Œæ¯”å¦‚æƒ³è¦å…¼å®¹ ie11ï¼Œåšä¸ªé…ç½®ï¼Œæ¡†æ¶å°±ä¼šåœ¨èƒŒååŠ è¡¥ä¸ï¼Œè½¬ es 5ï¼Œ
	- æ¯”å¦‚æƒ³è¦ç”¨ `external` è‡ªåŠ¨`æé€Ÿ`ï¼Œæƒ³è¦`é«˜æ¸…`æ–¹æ¡ˆï¼Œæƒ³è¦`åŸ‹ç‚¹`ï¼Œæƒ³è¦ç”¨ `esbuild å‹ç¼©`ï¼Œéƒ½æ˜¯ä¸€ä¸ª**é…ç½®çš„äº‹æƒ…**ï¼›
- é…ç½®==çº¦å®šåŒ–==äº†
	- æœ‰äº›åœºæ™¯é…ç½®åŒ–è¿˜æ˜¯ç¹çäº†ï¼Œæ¯”å¦‚è·¯ç”±ã€æ•°æ®æµ modelã€å›½é™…åŒ–è¯­è¨€æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡çº¦å®šçš„æ–¹å¼ï¼Œå°±æ²¡å¿…è¦åšé…ç½®äº†ï¼›

è¿™æ˜¯å› ä¸ºæ¡†æ¶éƒ½å¸®ä½ åšäº†

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-4.png)

é‚£ä¹ˆ`ç¼–è¯‘æ—¶æ¡†æ¶`å’Œ`éç¼–è¯‘æ—¶æ¡†æ¶`çš„åŒºåˆ«æ˜¯å•¥ï¼Ÿ
- `éç¼–è¯‘æ—¶æ¡†æ¶`
	- æ¯”å¦‚éå¸¸æµè¡Œçš„ `create-react-app`ï¼ŒæŠŠæºç ç®€å•ç›´æ¥åœ°äº¤ç»™ `webpack` å°±å®Œæˆä½¿å‘½ï¼›
- `ç¼–è¯‘æ—¶æ¡†æ¶`åˆ™ä¼šè‡ªå·±åŠ å¾ˆå¤šæˆ
	- æ¯”å¦‚æ‹¿åˆ°æºç å==åš ast åˆ†æï¼Œæ‹¿åˆ°ä¾èµ–å›¾è°±ï¼Œåšæ£€æŸ¥ï¼Œç”Ÿæˆä¸´æ—¶æ–‡ä»¶==ï¼Œç­‰ç­‰ï¼Œ
		- æœ€åæŠŠç¼–è¯‘åçš„æºç äº¤ç»™ `webpack`ï¼Œè¿™ä¸­é—´çš„å¾ˆå¤šäº‹ï¼Œæœ¬æ¥æ˜¯éœ€è¦å¼€å‘è€…æ‰‹åŠ¨å¤„ç†æˆ–ç¼–ç çš„ã€‚

### 3.1. ç¤¾åŒºçš„ç¼–è¯‘ui

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-6.png)


ç¤¾åŒºæœ‰å¾ˆå¤šç¼–è¯‘æ—¶çš„å°è¯•
- æ¯”å¦‚ Angular çš„ AOT å’Œ JITï¼Œå¯ä»¥==ç®€å•ç†è§£ AOT ä¸ºç¼–è¯‘æ—¶ï¼ŒJIT ä¸ºè¿è¡Œæ—¶==
	- AOT å¯ä»¥è®©äº§ç‰©æ›´å°ï¼ŒåŒæ—¶è¿è¡Œæ›´å¿«ï¼›
- æ¯”å¦‚ facebook ä¹‹å‰å‡ºçš„ `prepack`ï¼Œä¹Ÿæ˜¯ç¼–è¯‘æ—¶ä¼˜åŒ–çš„å°è¯•ï¼Œåœ¨ä¿è¯ç»“æœä¸€è‡´çš„å‰æä¸‹ï¼Œæ”¹å˜æºç ï¼Œè®©æ€§èƒ½æ›´å¿«ï¼›
- è¿˜æœ‰æœ€è¿‘çš„ `React Forget` æ›´æ˜¯ç¼–è¯‘æ—¶ä¼˜åŒ–çš„å…¸å‹ã€‚

Umi åšäº†å¾ˆå¤šç¼–è¯‘æ—¶çš„äº‹ï¼Œå¦‚æœä½ ç”¨è¿‡ umiï¼Œåº”è¯¥äº†è§£ src ä¸‹æœ‰ä¸ª `.umi ä¸´æ—¶ç›®å½•`ï¼Œ
- è¿™é‡Œå­˜æ”¾çš„æ–‡ä»¶æœ¬æ˜¯éœ€è¦å¼€å‘è€…è‡ªå·±å†™çš„ï¼Œç°åœ¨ç”±æ¡†æ¶æˆ–æ’ä»¶åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨ç”Ÿæˆã€‚
	- æ¯”å¦‚åœ¨ `pages` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å³æ˜¯**è·¯ç”±**
	- æ–°å»º `access.ts` æ–‡ä»¶å³æ˜¯**æƒé™**
	- åœ¨ `locales` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å³æ˜¯`å›½é™…åŒ–è¯­è¨€`
	- ç­‰ç­‰

### 3.2. Normal Mode ã€ Low Import Mode 

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-7.png)


- è¿™éƒ¨åˆ†çš„ `One More Thing` æ˜¯ `Low Import` å¼€å‘æ¨¡å¼ï¼Œä»–ä¼šéšç€ Umi 4 å‘å¸ƒï¼Œä½†é»˜è®¤ä¸å¼€å¯ã€‚
- å·¦å›¾æ˜¯å¼€å¯å‰ï¼Œå³å›¾æ˜¯å¼€å¯åï¼ŒåŒºåˆ«æ˜¯`å¤§éƒ¨åˆ† import è¯­å¥`ä¸ç”¨å†™ï¼Œäº¤ç»™æ¡†æ¶è‡ªåŠ¨è¡¥å…¨ã€‚
	- `webstorm` æŠ¥é”™æ€ä¹ˆåŠï¼Ÿ
- è¿™ä¸ªæ–¹æ¡ˆå¾ˆæœ‰äº‰è®®ï¼Œå–œæ¬¢çš„å¾ˆå–œæ¬¢ï¼Œä¸å–œæ¬¢çš„å¾ˆä¸å–œæ¬¢ï¼Œä½†ä¸ç®¡å¦‚ä½•ï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘æ—¶é¢†åŸŸçš„ä¸€æ¬¡å°è¯•ã€‚

### 3.3. ä¾èµ–é¢„æ‰“åŒ…

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-8.png)

- ä¸çŸ¥å¤§å®¶æ˜¯å¦æœ‰æ­¤ç»å†ã€‚ç¡ä¸€è§‰é†’æ¥ï¼Œå¾ˆå¤šäº‹å‘ç”Ÿäº†å˜åŒ–ã€‚
- æ¯”å¦‚ dev æˆ– build è·‘ä¸èµ·æ¥ï¼Œå•¥éƒ½æ²¡å¹²è¿­ä»£å‘å¸ƒåçº¿ä¸Šç™½å±è¿˜èƒŒäº†ä¸ªæ•…éšœ
	- `npm i` æ—¶å‡ºç°æŸäººçš„æ±‚èŒå¹¿å‘Šï¼Œä¾èµ–åº“è¢«é»‘å®¢æŒ‚é©¬ï¼Œç­‰ç­‰ã€‚
	- ä¹‹å‰ ==antd ç‰ˆæœ¬åœ£è¯èŠ‚é‚£å¤©== ï¼Œlogo å‡ºç°åœ£è¯å¸½
- ç„¶åä½ æ‰“å¼€ **package.json ä¸€çœ‹ï¼Œåªæœ‰ 10 ä¸ªä¾èµ–å‘€ï¼Œæˆ‘è¿˜å†™æ­»äº†ç‰ˆæœ¬**ï¼Œè¿™æ˜¯ä¸ºå•¥ï¼Ÿ
	- å› ä¸ºä½ å¿½ç•¥äº†æˆåƒä¸Šä¸‡çš„é—´æ¥ä¾èµ–ï¼Œè€Œè¿™äº›ä¾èµ–æ€»æœ‰ä¸€ä¸ªä¼šå‘ç”Ÿç‚¹æ„å¤–ï¼Œæ¯”å¦‚æŸä¸ªä¾èµ–çš„ä¸å…¼å®¹æ›´æ–°ï¼Œå°±ä¼šå¯¼è‡´ä½ é¡¹ç›®æŒ‚æ‰

### 3.4. é™„ï¼šSemver

`Semver` æ˜¯ ==Semantic Versioningï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰==çš„ç¼©å†™

#### 3.4.1. Semver åŸºæœ¬ç»“æ„

ç‰ˆæœ¬å·æ ¼å¼ï¼š**ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·**ï¼ˆMAJOR.MINOR.PATCHï¼‰

````mermaid
  graph TB
    A[2.3.4] --> B[ä¸»ç‰ˆæœ¬å·<br>Major<br>2]
    A --> C[æ¬¡ç‰ˆæœ¬å·<br>Minor<br>3]
    A --> D[ä¿®è®¢å·<br>Patch<br>4]
    
    B --> B1[ç ´åæ€§æ›´æ–°<br>ä¸å…¼å®¹çš„APIä¿®æ”¹]
    C --> C1[æ–°åŠŸèƒ½<br>å‘ä¸‹å…¼å®¹]
    D --> D1[Bugä¿®å¤<br>å‘ä¸‹å…¼å®¹]

    style A fill:#f9f,stroke:#333,stroke-width:4px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#bbf,stroke:#333,stroke-width:2px
    style D fill:#bbf,stroke:#333,stroke-width:2px
````

#### 3.4.2. ç‰ˆæœ¬å·å«ä¹‰

1. **ä¸»ç‰ˆæœ¬å·ï¼ˆMajorï¼‰**
   - å½“è¿›è¡Œä¸å…¼å®¹çš„ API ä¿®æ”¹æ—¶é€’å¢
   - ä¾‹å¦‚ï¼šä» 1.x.x å‡çº§åˆ° 2.0.0

2. **æ¬¡ç‰ˆæœ¬å·ï¼ˆMinorï¼‰**
   - å½“==æ·»åŠ åŠŸèƒ½ä½†ä¿æŒå‘ä¸‹å…¼å®¹æ—¶==é€’å¢
   - ä¾‹å¦‚ï¼šä» 1.1.x å‡çº§åˆ° 1.2.0

3. **ä¿®è®¢å·ï¼ˆPatchï¼‰**
   - å½“==åšå‘ä¸‹å…¼å®¹çš„ç¼ºé™·ä¿®å¤æ—¶==é€’å¢
   - ä¾‹å¦‚ï¼šä» 1.1.1 å‡çº§åˆ° 1.1.2

#### 3.4.3. ç‰ˆæœ¬èŒƒå›´ç¬¦å·

```json
{
  "dependencies": {
    "package1": "^1.2.3",  // å…¼å®¹ 1.x.x
    "package2": "~1.2.3",  // å…¼å®¹ 1.2.x
    "package3": ">=1.2.3", // å¤§äºç­‰äº 1.2.3
    "package4": "1.2.3",   // ç²¾ç¡®ç‰ˆæœ¬ 1.2.3
    "package5": "*"        // ä»»æ„ç‰ˆæœ¬
  }
}
```

ç¬¦å·è¯´æ˜ï¼š
- `^`ï¼šå…è®¸æ¬¡ç‰ˆæœ¬å’Œä¿®è®¢ç‰ˆæœ¬æ›´æ–°
- `~`ï¼šåªå…è®¸ä¿®è®¢ç‰ˆæœ¬æ›´æ–°
- `>`ï¼šå¤§äºæŒ‡å®šç‰ˆæœ¬
- `>=`ï¼šå¤§äºç­‰äºæŒ‡å®šç‰ˆæœ¬
- `<`ï¼šå°äºæŒ‡å®šç‰ˆæœ¬
- `<=`ï¼šå°äºç­‰äºæŒ‡å®šç‰ˆæœ¬
- `*`ï¼šä»»æ„ç‰ˆæœ¬
- `x`ï¼šä»»æ„ç‰ˆæœ¬ï¼ˆåŒ `*`ï¼‰

#### 3.4.4. ç‰ˆæœ¬ç¤ºä¾‹

```plaintext
ç‰ˆæœ¬å·ç¤ºä¾‹ï¼š
1.0.0ï¼šé¦–ä¸ªç¨³å®šç‰ˆæœ¬
1.0.1ï¼šä¿®å¤bug
1.1.0ï¼šæ·»åŠ æ–°åŠŸèƒ½ï¼Œå‘ä¸‹å…¼å®¹
2.0.0ï¼šè¿›è¡Œäº†ç ´åæ€§æ›´æ–°
```

#### 3.4.5. é¢„å‘å¸ƒç‰ˆæœ¬

```plaintext
é¢„å‘å¸ƒç‰ˆæœ¬æ ‡è¯†ï¼š
1.0.0-alphaï¼šå†…éƒ¨æµ‹è¯•ç‰ˆ
1.0.0-betaï¼šå…¬æµ‹ç‰ˆæœ¬
1.0.0-rcï¼šå€™é€‰å‘å¸ƒç‰ˆ
```

#### 3.4.6. å®é™…åº”ç”¨åœºæ™¯

```json
// package.json ç¤ºä¾‹
{
  "name": "my-project",
  "version": "1.2.3",
  "dependencies": {
    // ç”Ÿäº§ç¯å¢ƒä¾èµ–æ¨èä½¿ç”¨ç¡®åˆ‡ç‰ˆæœ¬
    "react": "17.0.2",
    
    // å¼€å‘ä¾èµ–å¯ä»¥ä½¿ç”¨æ›´å®½æ¾çš„ç‰ˆæœ¬èŒƒå›´
    "typescript": "^4.5.0",
    
    // æµ‹è¯•æ¡†æ¶ç‰ˆæœ¬
    "jest": "~27.0.0"
  }
}
```

#### 3.4.7. ç‰ˆæœ¬é€‰æ‹©å»ºè®®

1. **ç”Ÿäº§ä¾èµ–**
   - ä½¿ç”¨ç²¾ç¡®ç‰ˆæœ¬å·
   - é¿å…ä½¿ç”¨ `^` æˆ– `~`
   - æ‰‹åŠ¨æ§åˆ¶ç‰ˆæœ¬æ›´æ–°

2. **å¼€å‘ä¾èµ–**
   - å¯ä»¥ä½¿ç”¨ `^` è·å–æ–°ç‰¹æ€§
   - ä½¿ç”¨ `~` è·å–bugä¿®å¤
   - å®šæœŸæ›´æ–°å’Œæµ‹è¯•

3. **æµ‹è¯•ä¾èµ–**
   - å¯ä»¥ä½¿ç”¨è¾ƒå®½æ¾çš„ç‰ˆæœ¬èŒƒå›´
   - æ³¨æ„ä¸»ç‰ˆæœ¬æ›´æ–°çš„ç ´åæ€§å˜æ›´

#### 3.4.8. æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬é”å®š**
   ```bash
   # ç”Ÿæˆ package-lock.json
   npm install --save-exact
   ```

2. **ç‰ˆæœ¬æ›´æ–°**
   ```bash
   # æ£€æŸ¥è¿‡æ—¶çš„åŒ…
   npm outdated
   
   # æ›´æ–°åˆ°æ–°ç‰ˆæœ¬
   npm update
   ```

3. **å®‰å…¨æ€§æ£€æŸ¥**
   ```bash
   # æ£€æŸ¥å®‰å…¨æ¼æ´
   npm audit
   
   # ä¿®å¤å®‰å…¨é—®é¢˜
   npm audit fix
   ```

#### 3.4.9. æ³¨æ„äº‹é¡¹

1. **é¿å…ä½¿ç”¨ä¸å®‰å…¨çš„ç‰ˆæœ¬èŒƒå›´**
   - ä¸è¦ä½¿ç”¨ `*`
   - è°¨æ…ä½¿ç”¨ `>`
   - é¿å…è¿‡äºå®½æ¾çš„ç‰ˆæœ¬èŒƒå›´

2. **ä¿æŒä¾èµ–æ›´æ–°**
   - å®šæœŸæ£€æŸ¥æ›´æ–°
   - æµ‹è¯•æ–°ç‰ˆæœ¬
   - è®°å½•æ›´æ–°æ—¥å¿—

3. **ç‰ˆæœ¬æ§åˆ¶**
   - æäº¤ package-lock.json
   - ç»Ÿä¸€å›¢é˜Ÿç‰ˆæœ¬ç®¡ç†ç­–ç•¥
   - å»ºç«‹ç‰ˆæœ¬æ›´æ–°æµç¨‹

#### 3.4.10. ä¾èµ–å†²çªé—®é¢˜

```plaintext
é¡¹ç›®ç»“æ„ç¤ºä¾‹ï¼š
my-app
â”œâ”€â”€ package.json
â”œâ”€â”€ node_modules
â”‚   â”œâ”€â”€ package-a (ä¾èµ– lodash@^4.0.0)
â”‚   â””â”€â”€ package-b (ä¾èµ– lodash@^3.0.0)
```

#### 3.4.11. è¿‡äºå®½æ¾çš„ç‰ˆæœ¬èŒƒå›´

```json hl:3
{
  "dependencies": {
    // å±é™©çš„ç‰ˆæœ¬èŒƒå›´
    "express": "^4.0.0",    // å¯èƒ½å¼•å…¥ç ´åæ€§æ›´æ–°
    "lodash": "*",          // å®Œå…¨ä¸é™åˆ¶ç‰ˆæœ¬
    "moment": ">=2.0.0"     // è¿‡äºå®½æ³›çš„èŒƒå›´
  }
}
```

#### 3.4.12. é”æ–‡ä»¶é—®é¢˜

```json hl:7
// package-lock.json ç¤ºä¾‹
{
  "name": "my-project",
  "dependencies": {
    "package-a": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/package-a/-/package-a-1.2.3.tgz",
      "integrity": "sha512..."
    }
  }
}
```

#### 3.4.13. ä½¿ç”¨ç²¾ç¡®ç‰ˆæœ¬

```json
{
  "dependencies": {
    "express": "4.17.1",        // ç²¾ç¡®ç‰ˆæœ¬
    "react": "17.0.2",          // ç²¾ç¡®ç‰ˆæœ¬
    "typescript": "4.5.4"       // ç²¾ç¡®ç‰ˆæœ¬
  }
}
```

#### 3.4.14. ä½¿ç”¨ package-lock.json

```bash
# ç¡®ä¿å›¢é˜Ÿæˆå‘˜éƒ½ä½¿ç”¨é”æ–‡ä»¶
npm ci  # è€Œä¸æ˜¯ npm install
```

#### 3.4.15. ç‰ˆæœ¬å›ºå®šç­–ç•¥

```json
{
  "dependencies": {
    // ä½¿ç”¨æ›´ä¸¥æ ¼çš„ç‰ˆæœ¬èŒƒå›´
    "express": "~4.17.1",     // åªå…è®¸è¡¥ä¸ç‰ˆæœ¬æ›´æ–°
    "react": "16.14.0",       // å®Œå…¨å›ºå®šç‰ˆæœ¬
    "lodash": "4.17.x"        // é™åˆ¶åœ¨ç‰¹å®šæ¬¡ç‰ˆæœ¬å†…
  }
}
```

#### 3.4.16. ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥

```bash
// .npmrc æ–‡ä»¶é…ç½®
save-exact=true              # ä¿å­˜ç²¾ç¡®ç‰ˆæœ¬
package-lock=true           # å¯ç”¨é”æ–‡ä»¶
```

#### 3.4.17. ä¾èµ–å®¡æŸ¥

```bash
# å®šæœŸæ£€æŸ¥ä¾èµ–æ›´æ–°
npm audit                    # å®‰å…¨å®¡è®¡
npm outdated                # æ£€æŸ¥è¿‡æ—¶åŒ…
```

#### 3.4.18. ä¾èµ–æ ‘åˆ†æ

```bash
# æŸ¥çœ‹ä¾èµ–æ ‘
npm ls                      # æŸ¥çœ‹å®Œæ•´ä¾èµ–æ ‘
npm ls package-name        # æŸ¥çœ‹ç‰¹å®šåŒ…çš„ä¾èµ–å…³ç³»

# æ‰å¹³åŒ–ä¾èµ–
npm dedupe                 # åˆ é™¤é‡å¤ä¾èµ–
```

#### 3.4.19. ç‰ˆæœ¬å†²çªè§£å†³

```bash
# å¼ºåˆ¶è§£æåˆ°ç‰¹å®šç‰ˆæœ¬
npm install package@version --force

# æˆ–ä½¿ç”¨ resolutionsï¼ˆåœ¨ package.json ä¸­ï¼‰
{
  "resolutions": {
    "package-name": "1.2.3"
  }
}
```

#### 3.4.20. é¢„é˜²æªæ–½

1. **ä½¿ç”¨é”æ–‡ä»¶**
   - å§‹ç»ˆæäº¤ package-lock.json
   - ä½¿ç”¨ `npm ci` è€Œä¸æ˜¯ `npm install`

2. **ç‰ˆæœ¬ç­–ç•¥**
   - ä¸ºç”Ÿäº§ä¾èµ–ä½¿ç”¨ç²¾ç¡®ç‰ˆæœ¬
   - ä¸ºå¼€å‘ä¾èµ–ä½¿ç”¨æ›´å®½æ¾çš„ç‰ˆæœ¬èŒƒå›´

3. **å®šæœŸç»´æŠ¤**
   - å®šæœŸæ›´æ–°ä¾èµ–
   - è¿è¡Œå®‰å…¨å®¡è®¡
   - æµ‹è¯•æ–°ç‰ˆæœ¬çš„å…¼å®¹æ€§

4. **å·¥å…·æ”¯æŒ**
   - ä½¿ç”¨ `npm-check-updates`
   - é…ç½®è‡ªåŠ¨åŒ–ä¾èµ–æ›´æ–°å·¥å…·
   - ä½¿ç”¨ CI/CD è¿›è¡Œä¾èµ–æ£€æŸ¥

#### 3.4.21. è‡ªå®šä¹‰ npm é…ç½®

```ini
# .npmrc
save-exact=true
package-lock=true
audit=true
fund=false
```

#### 3.4.22. ä½¿ç”¨å·¥ä½œåŒº

```json
// package.json
{
  "workspaces": [
    "packages/*"
  ]
}
```

### 3.5. Semver çš„ç†æƒ³å’Œç°å®

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-9.png)

### 3.6. ç¤¾åŒºçš„è§£

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-10.png)

ä¸´æ—¶çš„è§£å†³ï¼š
- æ¯”å¦‚ `cnpm` æä¾›çš„ `bug-versions`
- npm æä¾›çš„ `resolutions`ï¼Œä¾µå…¥å¼æ”¹ä»£ç çš„ `patch-package` ç­‰ï¼›
é•¿æœŸçš„
- æ¯”å¦‚ npmã€yarn å’Œ pnpm å…·å¤‡çš„ `lock èƒ½åŠ›`ï¼Œtnpm/cnpm ç›®å‰æš‚ä¸æ”¯æŒï¼Œä½†å¯ä»¥ç”¨ yarn modeã€‚

### 3.7. æ¡†æ¶çš„è§£

è¿˜æœ‰ä¸ªæ€è·¯æ˜¯ã€Œä¸­é—´å•†é”ä¾èµ–ï¼Œå®šæœŸæ›´æ–°ï¼Œå¹¶å¯¹æ­¤è´Ÿè´£ã€ã€‚==æ¡†æ¶æ˜¯å¼€å‘è€…çš„å€’æ•°ç¬¬äºŒé“é˜²çº¿==ï¼Œè‡ªç„¶è€Œç„¶å°±åº”è¯¥æ˜¯è¿™ä¸ªä¸­é—´å•†ã€‚

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-11.png)

è¿™ä¸ªæ€è·¯åœ¨ Umi é‡Œçš„å®ç°æ˜¯**ä¾èµ–é¢„æ‰“åŒ…**ã€‚
- æ‰“åŒ…å‰ï¼ŒUmi é€šè¿‡ `dependency` ä¾èµ– webpackã€babel ç­‰ï¼Œè¿™æ—¶å¦‚æœ babel å‡ºç° bugï¼Œä¼šå¯¼è‡´ umi æŒ‚ï¼Œç„¶åç”¨æˆ·é¡¹ç›®ä¹ŸæŒ‚ï¼Œç¡ä¸å¥½ï¼ŒğŸ˜´ï¼›
- æ‰“åŒ…åï¼ŒUmi é€šè¿‡ `devDependency` ä¾èµ– webpackã€babel ç­‰ï¼Œå¦‚æœ babel åˆå‡ºç° bugï¼ŒUmi ä¼šä¸ä¼šå—å½±å“ï¼ŒUmi ç”¨æˆ·çš„é¡¹ç›®ä¹Ÿä¸ä¼šå—å½±å“ï¼Œç¡å¾—é¦™ï¼ŒğŸ˜„ã€‚

### 3.8. æ€ä¹ˆé¢„æ‰“åŒ…

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-12.png)

- https://github.com/vercel/ncc
	- ç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºå°† Node.js æ¨¡å—**ç¼–è¯‘æˆä¸€ä¸ªå•ä¸€æ–‡ä»¶ï¼Œè¿åŒå…¶æ‰€æœ‰ä¾èµ–é¡¹ï¼Œç±»ä¼¼äº gcc é£æ ¼**ã€‚

- ç®€å•ä»‹ç»ä¸‹å¦‚ä½•é¢„æ‰“åŒ…ï¼Œåˆ†ä»£ç å’Œç±»å‹å®šä¹‰ä¸¤éƒ¨åˆ†
	- åˆ†åˆ«é€šè¿‡ ncc å’Œ dts-packer å®ç°ã€‚
		- æ¯”å¦‚ webpackï¼Œå€ŸåŠ©ä¸¤ä¸ªå·¥å…·ï¼Œä¼šåˆ†åˆ«åœ¨ compiled/webpack ç›®å½•ç”Ÿæˆ `index.js` å’Œ `index.d.ts`ï¼Œä»¥å®ç°é¢„æ‰“åŒ…çš„ç›®çš„

### 3.9. Father

è¿™éƒ¨åˆ†çš„ One More Thing æ˜¯ Father çš„ä¸‹ä¸ªç‰ˆæœ¬ V4ï¼Œä»–æ˜¯åŸºäº Umi çš„ç»„ä»¶æ‰“åŒ…å·¥å…·ï¼Œåœ¨ V4 é‡Œï¼Œé™¤äº†å…¶ä»– nb çš„ç‰¹æ€§å¤–ï¼Œè¿˜æœ‰ä¸ªé‡è¦çš„ç‚¹å°±æ˜¯å‰é¢æˆ‘ä»¬ä»‹ç»çš„ä¾èµ–é¢„æ‰“åŒ…åŠŸèƒ½ï¼Œå¤§å®¶å¯ä»¥æœŸå¾…ä¸‹ã€‚

![å›¾ç‰‡&æ–‡ä»¶](./files/20241210-13.png)

## 4. æ•°æ®é‡åŒ–

- æœåŠ¡äº† `10000+` é¡¹ç›®
	- å¦‚ä½•ç»Ÿè®¡å‘¢ï¼Ÿ